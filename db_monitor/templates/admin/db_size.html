{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="table-body">

    <div class="table-header">
        <h1>Database Size Report</h1>
        <button id="exportBtn">Export Table as CSV</button>
    </div>

    <p><strong>Database:</strong> {{ report.database }}</p>

    <!-- ===== Summary ===== -->
    <br>
    <h2>Summary</h2>
    <table class="summary-table">
        <thead>
            <tr>
                <th>Total Data Size</th>
                <th>Total Index Size</th>
                <th>Total Database Size</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>{{ report.total_data }}</td>
                <td>{{ report.total_index }}</td>
                <td>
                    <div class="memory-labels">
                        <span>Used: {{ report.database_size }}</span>
                        <span>Total: {{ report.DB_Bar_Cap }} MB</span>
                    </div>

                    <div class="size-bar-container">
                        <div class="size-bar {{ report.db_bar_color }}"
                             style="width: {{ report.db_percentage|floatformat:1 }}%;">
                            {{ report.db_percentage|floatformat:1 }}%
                        </div>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>

    <!-- ===== Table Details ===== -->
    <br>
    <h2>Table Details</h2>
    <table class="summary-table">
        <thead>
            <tr>
                <th>Table</th>
                <th>Data Size</th>
                <th>Index Size</th>
                <th>Total Size</th>
                <th>Usage</th>
            </tr>
        </thead>
        <tbody>
            {% for t in report.tables %}
            <tr>
                <td>{{ t.table }}</td>
                <td>{{ t.data }}</td>
                <td>{{ t.index }}</td>
                <td>{{ t.total }} {{ t.status_emoji }}</td>
                <td>
                    <!-- âœ… FIXED USAGE BAR -->
                    <div class="usage-wrapper">
                        <div class="size-bar-container usage-bar">
                            <div class="size-bar {{ t.bar_color }}"
                                 style="width: {{ t.percentage|floatformat:1 }}%;">
                            </div>
                        </div>
                        <span class="usage-text">
                            {{ t.percentage|floatformat:1 }}%
                        </span>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
document.getElementById("exportBtn").addEventListener("click", function () {
    const tables = document.querySelectorAll(".summary-table");
    let csv = [];

    function removeEmojis(text) {
        return text.replace(/[\p{Emoji_Presentation}\p{Extended_Pictographic}]/gu, '').trim();
    }

    tables.forEach((table, index) => {
        csv.push(index === 0 ? '"Summary Table"' : '"Table Details"');
        table.querySelectorAll("tr").forEach(row => {
            let rowData = [];
            row.querySelectorAll("th, td").forEach(cell => {
                rowData.push('"' + removeEmojis(cell.innerText) + '"');
            });
            csv.push(rowData.join(","));
        });
        csv.push("");
    });

    const csvFile = new Blob([csv.join("\n")], { type: "text/csv;charset=utf-8;" });
    const downloadLink = document.createElement("a");
    downloadLink.download = "database_report.csv";
    downloadLink.href = window.URL.createObjectURL(csvFile);
    downloadLink.click();
});
</script>
{% endblock %}
