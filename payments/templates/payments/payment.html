{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="page">
    <div class="payment-card">
        <h2>{{ product.title }}</h2>
        <p>One-time purchase â€¢ Instant download</p>
        <div class="price">â‚¹{{ product.price }}</div>

        <button id="pay-button" class="pay-btn">Pay Now</button>

        <div class="secure">ðŸ”’ Secure payment powered by Razorpay</div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
    const csrfToken = "{{ csrf_token }}";
    const razorpayOrderId = "{{ razorpay_order_id }}";
    const retryUrl = "{% url 'payments:retry_payment' razorpay_order_id %}";
    
    // âœ… Flag to prevent duplicate logging
    let isFailureLogged = false;

    /**
     * Log payment failure + redirect to retry page
     */
    function logPaymentFailure(reason, orderId) {
        if (isFailureLogged) return; // Exit if already logged for this attempt
        isFailureLogged = true;

        fetch("{% url 'payments:payment_failed' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": csrfToken
            },
            body: `order_id=${encodeURIComponent(orderId)}&error_msg=${encodeURIComponent(reason)}`
        })
        .finally(() => {
            Swal.fire({
                icon: "error",
                title: "Payment Failed",
                text: reason,
                confirmButtonText: "Retry Payment",
                confirmButtonColor: "#3085d6"
            }).then(result => {
                if (result.isConfirmed) {
                    window.location.href = retryUrl;
                }
            });
        });
    }

    const options = {
        key: "{{ razorpay_key_id }}",
        amount: "{{ amount }}",
        currency: "INR",
        name: "DevOpsVaultX",
        description: "{{ product.title }}",
        order_id: razorpayOrderId,

        handler: function (response) {
            const form = document.createElement("form");
            form.method = "POST";
            form.action = "{% url 'payments:payment_success' product.id %}";

            const fields = {
                razorpay_payment_id: response.razorpay_payment_id,
                razorpay_order_id: response.razorpay_order_id,
                razorpay_signature: response.razorpay_signature,
                csrfmiddlewaretoken: csrfToken
            };

            Object.entries(fields).forEach(([name, value]) => {
                const input = document.createElement("input");
                input.type = "hidden";
                input.name = name;
                input.value = value;
                form.appendChild(input);
            });

            document.body.appendChild(form);
            form.submit();
        },

        modal: {
            ondismiss: function () {
                // If the user closes the modal without the 'payment.failed' event firing first
                logPaymentFailure("User closed payment popup", razorpayOrderId);
            }
        },

        theme: {
            color: "#3399cc"
        }
    };

    const razorpay = new Razorpay(options);

    // Razorpay failure handler (fires on technical failures)
    razorpay.on("payment.failed", function (response) {
        const description = response.error.description || "Payment failed";
        logPaymentFailure(description, razorpayOrderId);
    });

    document.getElementById("pay-button").addEventListener("click", function (e) {
        e.preventDefault();
        isFailureLogged = false; // âœ… Reset flag before opening new payment instance
        razorpay.open();
    });
</script>
{% endblock %}