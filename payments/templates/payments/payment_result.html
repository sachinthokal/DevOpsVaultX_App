{% extends 'base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<div class="result-page-wrapper">
    <div class="bg-blur-purple"></div>
    <div class="bg-blur-blue"></div>

    <div class="result-container">
        <div id="toast" class="nexus-toast">
            <div class="status-visual">
                <div class="icon-ring"></div>
                <span id="statusIcon" class="main-icon">⌛</span>
            </div>

            <div class="content-wrapper">
                <h2 id="statusTitle">Processing Node...</h2>
                <p id="statusMessage">Syncing with DevOpsVaultX secure servers.</p>
                
                {% if file_url %}
                <div id="actionArea" class="action-reveal" style="display: none;">
                    <div class="download-container">
                        <button class="nexus-btn-sm" id="downloadBtn">
                            <i class="fas fa-download"></i> DOWNLOAD MANUALLY
                        </button>
                    </div>
                    <div class="redirect-footer">
                        <div class="nexus-loader-bar">
                            <div class="progress-fill"></div>
                        </div>
                        <p class="auto-msg">Redirecting to Vault in <span id="timer">5</span>s</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if file_url %}
<a id="downloadLink" href="{{ file_url }}" download hidden></a>
{% endif %}

<style>
    /* Layout & Background */
    .result-page-wrapper {
        background: #050811;
        min-height: 85vh;
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
        overflow: hidden;
        font-family: 'Inter', sans-serif;
    }

    .bg-blur-purple {
        position: absolute; top: -10%; left: -10%; width: 50%; height: 50%;
        background: radial-gradient(circle, rgba(191, 3, 237, 0.12) 0%, transparent 70%);
        filter: blur(100px);
    }

    .bg-blur-blue {
        position: absolute; bottom: -10%; right: -10%; width: 50%; height: 50%;
        background: radial-gradient(circle, rgba(59, 130, 246, 0.1) 0%, transparent 70%);
        filter: blur(100px);
    }

    /* Toast Box - Glassmorphism */
    .nexus-toast {
        background: rgba(15, 23, 42, 0.6);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 40px;
        padding: 60px 40px;
        width: 100%;
        max-width: 480px;
        text-align: center;
        opacity: 0;
        transform: translateY(40px) scale(0.98);
        transition: all 0.6s cubic-bezier(0.23, 1, 0.32, 1);
        box-shadow: 0 40px 100px rgba(0, 0, 0, 0.6);
        position: relative;
        z-index: 10;
    }

    .nexus-toast.show {
        opacity: 1;
        transform: translateY(0) scale(1);
    }

    /* Visual Icon Styling */
    .status-visual {
        position: relative;
        width: 100px;
        height: 100px;
        margin: 0 auto 30px;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .main-icon { font-size: 44px; z-index: 2; transition: 0.4s; color: #64748b; }

    .icon-ring {
        position: absolute; width: 100%; height: 100%;
        border-radius: 50%;
        border: 2px solid rgba(255, 255, 255, 0.05);
        transition: 0.5s ease;
    }

    /* Success/Failed Colors */
    .success-mode .icon-ring { border-color: #10b981; box-shadow: 0 0 20px rgba(16, 185, 129, 0.3); }
    .success-mode .main-icon { color: #10b981; }
    .success-mode { border-bottom: 4px solid #10b981; }

    .failed-mode .icon-ring { border-color: #ef4444; box-shadow: 0 0 20px rgba(239, 68, 68, 0.3); }
    .failed-mode .main-icon { color: #ef4444; }
    .failed-mode { border-bottom: 4px solid #ef4444; }

    /* Content Styling */
    .content-wrapper h2 { font-size: 28px; font-weight: 800; margin-bottom: 10px; color: #fff; letter-spacing: -1px; }
    .content-wrapper p { color: #94a3b8; font-size: 15px; margin-bottom: 0; line-height: 1.5; }

    /* Action Reveal Area */
    .action-reveal {
        margin-top: 40px;
        padding-top: 30px;
        border-top: 1px dashed rgba(255, 255, 255, 0.1);
        animation: fadeIn 0.5s ease-out forwards;
    }

    .nexus-btn-sm {
        background: #fff;
        color: #000;
        border: none;
        padding: 16px 32px;
        border-radius: 14px;
        font-size: 13px;
        font-weight: 800;
        cursor: pointer;
        transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        text-transform: uppercase;
        letter-spacing: 1px;
        display: inline-flex;
        align-items: center;
        gap: 10px;
    }

    .nexus-btn-sm:hover {
        background: #bf03ed;
        color: #fff;
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(191, 3, 237, 0.4);
    }

    /* Progress & Redirect */
    .redirect-footer { margin-top: 30px; }
    .nexus-loader-bar {
        width: 120px; height: 4px;
        background: rgba(255, 255, 255, 0.05);
        margin: 0 auto 12px;
        border-radius: 10px;
        overflow: hidden;
        position: relative;
    }
    .progress-fill {
        position: absolute; left: 0; top: 0; height: 100%; width: 0%;
        background: #bf03ed;
        border-radius: 10px;
    }

    .auto-msg { font-size: 12px !important; color: #475569 !important; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const toast = document.getElementById("toast");
        const statusIcon = document.getElementById("statusIcon");
        const statusTitle = document.getElementById("statusTitle");
        const statusMessage = document.getElementById("statusMessage");
        const actionArea = document.getElementById("actionArea");
        const downloadLink = document.getElementById("downloadLink");
        const downloadBtn = document.getElementById("downloadBtn");
        const timerSpan = document.getElementById("timer");
        const progressFill = document.querySelector(".progress-fill");

        const paymentStatus = "{{ status|default:'failed' }}";
        const isFree = "{{ is_free|yesno:'true,false' }}"; 

        // 1. Entrance Animation
        setTimeout(() => toast.classList.add("show"), 200);

        // 2. State Management
        if (paymentStatus === "success") {
            toast.classList.add("success-mode");
            statusIcon.textContent = "✓";
            
            if (isFree === "true") {
                statusTitle.textContent = "Access Granted";
                statusMessage.textContent = "The resource is free! Initializing your secure vault download...";
            } else {
                statusTitle.textContent = "Payment Verified";
                statusMessage.textContent = "Transaction confirmed. Your DevOps assets are ready for deployment.";
            }

            // 3. Auto-Download & Action Reveal
            if (downloadLink) {
                setTimeout(() => {
                    downloadLink.click(); 
                    if(actionArea) {
                        actionArea.style.display = "block";
                        // Start Progress Bar Animation (6 seconds)
                        if(progressFill) progressFill.style.transition = "width 6s linear";
                        if(progressFill) setTimeout(() => progressFill.style.width = "100%", 50);
                        
                        // Countdown Timer
                        let timeLeft = 5;
                        const countdown = setInterval(() => {
                            timeLeft--;
                            if(timerSpan) timerSpan.textContent = timeLeft;
                            if(timeLeft <= 0) clearInterval(countdown);
                        }, 1000);
                    }
                }, 1200);
            }

            // 4. Final Redirect
            setTimeout(() => {
                window.location.href = "{% url 'vaultx:index' %}";
            }, 6500);

        } else {
            // Failure State
            toast.classList.add("failed-mode");
            statusIcon.textContent = "✕";
            statusTitle.textContent = "Node Error";
            statusMessage.textContent = "Transaction failed or handshake timed out. Please try again.";
            
            setTimeout(() => {
                window.location.href = "{% url 'products:list' %}";
            }, 4000);
        }

        // Manual Download Click
        if (downloadBtn) {
            downloadBtn.addEventListener("click", () => {
                downloadLink.click();
            });
        }
    });
</script>
<script>
    // Browser history lock to prevent back navigation
    history.pushState(null, null, location.href);
    window.onpopstate = function () {
        location.href = "{% url 'products:list' %}"; 
    };
</script>
{% endblock %}