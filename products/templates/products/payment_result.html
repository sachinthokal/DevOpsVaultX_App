{% extends 'base.html' %}
{% load static %}

{% block content %}
<div id="toast" class="toast">
  <div class="icon">✔️</div>
  <div class="message">Processing...</div>
  {% if file_url %}
  <button class="btn-download" id="downloadBtn">Download</button>
  {% endif %}
</div>

{% if file_url %}
<a id="downloadLink" href="{{ file_url }}" download hidden></a>
{% endif %}

<style>
  /* Toast styling */
  .toast {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.9);
    background: #1e1e2f;
    color: #fff;
    padding: 20px 30px;
    border-radius: 15px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
    display: flex;
    align-items: center;
    gap: 15px;
    opacity: 0;
    transition: all 0.3s ease;
    z-index: 9999;
  }

  .toast.show {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
  }

  .toast .icon { font-size: 2rem; }
  .toast .message { font-size: 1.1rem; font-weight: 500; }

  .toast .btn-download {
    background: #4caf50;
    color: #fff;
    border: none;
    padding: 8px 15px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
    transition: background 0.2s ease;
  }

  .toast .btn-download:hover { background: #45a049; }

  /* Colors */
  .toast.success { background: #1e462f; }
  .toast.failed { background: #46201e; }
  .toast.free { background: #1e3a46; } /* Optional: Free sathi blue tint */
</style>

<script>
  const toast = document.getElementById("toast");
  const icon = toast.querySelector(".icon");
  const message = toast.querySelector(".message");
  const downloadBtn = document.getElementById("downloadBtn");

  // Django kadun alela status ani is_free flag
  const paymentStatus = "{{ status|default:'failed' }}";
  const isFree = "{{ is_free|yesno:'true,false' }}"; 

  // Update toast based on status
  if (paymentStatus === "success") {
    toast.classList.add("success");
    icon.textContent = "✅";
    
    // Check kara jar mofat asel tar
    if (isFree === "true") {
        message.textContent = "It's Free !! Download your file now...";
    } else {
        message.textContent = "Payment successful !! Download your file now...";
    }
  } else {
    toast.classList.add("failed");
    icon.textContent = "❌";
    message.textContent = "Payment failed! Please try again...";
  }

  // Show toast
  setTimeout(() => toast.classList.add("show"), 200);

  // Download button functionality
  if (downloadBtn) {
    downloadBtn.addEventListener("click", () => {
      document.getElementById("downloadLink").click();
      
      // Download suru zalya nantr redirect kara
      setTimeout(() => {
          toast.classList.remove("show");
          window.location.href = "{% url 'products:list' %}";
      }, 2000);
    });
  }

  // Redirect on failure
  if (paymentStatus === "failed") {
    setTimeout(() => {
      window.location.href = "{% url 'products:list' %}";
    }, 5000);
  }
</script>
{% endblock %}