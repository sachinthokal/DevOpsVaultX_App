{% extends 'base.html' %}
{# path: vaultx/templates/vaultx/dashboard.html #}
{% load static %} 

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
<link rel="stylesheet" href="{% static 'vaultx/css/dashboard.css' %}">
<script src="{% static 'vaultx/js/dashboard.js' %}"></script>

{% if messages %}
  {% for message in messages %}
    <div class="django-message" data-type="{{ message.tags }}" data-text="{{ message }}"></div>
  {% endfor %}
{% endif %}

<div class="vault-grid">
  {% for payment in payments %}
  <div class="asset-card" id="card-{{ payment.id }}">
    
    <div class="top-actions">
      <button class="action-circle btn-history" 
              onclick="showHistory('{{ payment.razorpay_order_id }}', '{{ payment.created_at|date:'d M Y' }}', '{{ payment.updated_at|date:'d M Y' }}', '{{ payment.download_used }}', '{{ payment.purchase_count|default:1 }}','{{ request.user.get_full_name|default:request.user.username|default:'New User' }}', '{{ request.user.email|default:'Not Linked' }}')" 
              title="History">
        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
      </button>
      
      <button class="action-circle btn-delete" onclick="removeItem('{{ payment.id }}')" title="Remove">
        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"></path></svg>
      </button>
    </div>

    <div style="display: flex; gap: 6px; flex-wrap: wrap">
      <span class="status-badge">
        {% if not payment.file_exists or payment.download_used >= payment.download_limit %}
            <span style="color: #ef4444;">üîí Locked</span>
        {% else %}
            <span style="color: #10b981;">‚ú® Active</span>
        {% endif %}
      </span>
      {% if payment.purchase_count > 1 %}
      <span class="status-badge" style="background: rgba(46, 213, 115, 0.1); color: #2ed573;">x{{ payment.purchase_count }}</span>
      {% endif %}
    </div>

    <h3 class="product-title">{{ payment.product.title }}</h3>

    <div class="progress-section">
      <div style="display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 6px;">
        <span style="color: var(--text-muted)">Credits</span>
        <span style="font-weight:700; color: {% if payment.download_used >= payment.download_limit %}var(--danger){% else %}var(--accent){% endif %};">
          {{ payment.download_used }} / {{ payment.download_limit }}
        </span>
      </div>
      <div class="progress-container">
        <div class="progress-bar" style="width: {% widthratio payment.download_used payment.download_limit 100 %}%"></div>
      </div>
    </div>

    <div class="action-area" style="margin-top: auto">
      
      {% if payment.download_used >= payment.download_limit %}
        <a href="{% url 'products:detail' payment.product.id %}" class="btn-download buy-again-btn">Renew Access</a>
      
      {% elif not payment.file_exists %}
        <button class="btn-download" style="background: rgba(255, 71, 87, 0.1); color: #ff4757; border: 1px solid rgba(255, 71, 87, 0.2); cursor: not-allowed; width: 100%;" disabled>
            ‚ö†Ô∏è ASSET EXPIRED
        </button>
        <p style="font-size: 10px; color: #ff4757; text-align: center; margin-top: 5px; font-weight: 800; letter-spacing: 0.5px;">FILE REMOVED FROM DATABASE</p>
      
      {% else %}
        <button onclick="handleDownload('{{ payment.product.id }}', '{{ payment.id }}')" class="btn-download active-btn" id="btn-{{ payment.id }}">Download</button>
      {% endif %}

    </div>
  </div>

  {% empty %}
  <div style="grid-column: 1/-1; text-align: center; padding: 100px 20px">
    <h2 style="color: #64748b; font-size: 1.8rem; font-weight: 800">VAULT EMPTY</h2>
    <a href="/" style="background: var(--accent); color: white; padding: 15px 40px; border-radius: 12px; text-decoration: none; font-weight: 800;">Explore Store</a>
  </div>
  {% endfor %}
</div>
<script>
    history.pushState(null, null, location.href);
    window.onpopstate = function () {
        location.href = "{% url 'products:list' %}"; 
    };
</script>

{% endblock %}